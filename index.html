<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Live Location Share</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin:0; background:#111; color:#fff; font-family:sans-serif; height:100vh; display:flex; flex-direction:column; }
#map { flex:1; }
.controls { padding:10px; background:#222; }
button { width:100%; padding:12px; font-size:16px; border:none; border-radius:5px; cursor:pointer; }
#start { background:#27ae60; color:#fff; }
#copy { background:#2980b9; color:#fff; margin-top:8px; }
#info { text-align:center; color:#ffcc00; margin-bottom:8px; }
#coords { text-align:center; font-size:13px; margin-top:5px; color:#0f0; }
</style>
</head>

<body>

<div id="map"></div>

<div class="controls">
    <div id="info">Room ID: <b id="room"></b></div>
    <button id="start">START SHARING (Device 1)</button>
    <button id="copy">COPY LINK (Send to Device 2)</button>
    <div id="coords"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt-min.js"></script>

<script>
/* ---------------- ROOM SETUP ---------------- */
const params = new URLSearchParams(location.search);
let room = params.get("id");

if (!room) {
    room = "loc_" + Math.random().toString(36).substr(2, 6);
    history.replaceState({}, "", "?id=" + room);
}

document.getElementById("room").innerText = room;
const TOPIC = "live_location/" + room;

/* ---------------- MAP ---------------- */
const map = L.map("map").setView([20.59, 78.96], 5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let marker = null;
let accuracyCircle = null;

/* ---------------- MQTT ---------------- */
const client = new Paho.MQTT.Client(
    "broker.hivemq.com",
    8000,
    "client_" + Math.random().toString(16).substr(2, 8)
);

client.onMessageArrived = (msg) => {
    try {
        const d = JSON.parse(msg.payloadString);
        updateMap(d.lat, d.lng, d.acc);
    } catch (e) {
        console.error("Bad message", e);
    }
};

client.connect({
    useSSL: true,
    onSuccess: () => client.subscribe(TOPIC),
    onFailure: (e) => alert("MQTT Error: " + e.errorMessage),
});

/* ---------------- MAP UPDATE ---------------- */
function updateMap(lat, lng, acc) {
    const pos = [lat, lng];

    if (!marker) {
        marker = L.marker(pos).addTo(map);
        accuracyCircle = L.circle(pos, { radius: acc, color: "#00f" }).addTo(map);
        map.setView(pos, 16);
    } else {
        marker.setLatLng(pos);
        accuracyCircle.setLatLng(pos).setRadius(acc);
    }

    document.getElementById("coords").innerText =
        `Lat: ${lat.toFixed(5)} | Lng: ${lng.toFixed(5)} | Accuracy: ${Math.round(acc)}m`;
}

/* ---------------- SHARING ---------------- */
document.getElementById("start").onclick = () => {
    navigator.geolocation.watchPosition(
        (p) => {
            const payload = {
                lat: p.coords.latitude,
                lng: p.coords.longitude,
                acc: p.coords.accuracy,
                t: Date.now()
            };

            const msg = new Paho.MQTT.Message(JSON.stringify(payload));
            msg.destinationName = TOPIC;
            msg.retained = true; // VERY IMPORTANT
            client.send(msg);

            updateMap(payload.lat, payload.lng, payload.acc);
        },
        (err) => alert("GPS Error: " + err.message),
        { enableHighAccuracy: true, maximumAge: 0 }
    );
};

/* ---------------- COPY LINK ---------------- */
document.getElementById("copy").onclick = async () => {
    await navigator.clipboard.writeText(location.href);
    alert("Link copied. Open on Device 2.");
};
</script>

</body>
</html>
