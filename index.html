<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bargarh Live Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
    margin: 0;
    font-family: sans-serif;
    background: #1a1a1a;
    color: #fff;
}
#map {
    height: 60vh;
    width: 100%;
    background: #222;
}
.controls {
    padding: 15px;
    text-align: center;
}
button {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
button:active {
    background: #0056b3;
}
#status {
    margin-top: 10px;
    color: #ffcc00;
}
#debug {
    height: 20vh;
    background: #000;
    color: #0f0;
    font-family: monospace;
    font-size: 12px;
    padding: 10px;
    overflow-y: auto;
}
.label {
    font-size: 12px;
    color: #aaa;
    margin-bottom: 6px;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="controls">
    <div class="label">ROOM ID: <span id="room-id">...</span></div>
    <button id="start-btn">START TRACKING</button>
    <div id="status">Status: Ready</div>
</div>

<div id="debug">--- SYSTEM LOG ---<br></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<script>
/* ---------------- LOG ---------------- */
function log(msg) {
    const d = document.getElementById("debug");
    d.innerHTML += "> " + msg + "<br>";
    d.scrollTop = d.scrollHeight;
}

/* ---------------- ROOM ---------------- */
const params = new URLSearchParams(location.search);
let roomID = params.get("id");
if (!roomID) {
    roomID = "room_" + Math.random().toString(16).slice(2, 8);
    history.replaceState({}, "", "?id=" + roomID);
}
document.getElementById("room-id").innerText = roomID;
const TOPIC = "bargarh_live/" + roomID;

/* ---------------- MAP ---------------- */
const map = L.map("map").setView([20.59, 78.96], 5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let marker = null;
let circle = null;

function updateMap(lat, lng, acc) {
    const pos = [lat, lng];
    if (!marker) {
        marker = L.circleMarker(pos, {
            radius: 8,
            color: "red",
            fillOpacity: 1
        }).addTo(map);

        circle = L.circle(pos, {
            radius: acc,
            color: "#00f"
        }).addTo(map);

        map.setView(pos, 16);
    } else {
        marker.setLatLng(pos);
        circle.setLatLng(pos).setRadius(acc);
    }
}

/* ---------------- MQTT (FIXED) ---------------- */
log("Connecting to MQTT...");
const client = new Paho.MQTT.Client(
    "broker.hivemq.com",
    8884,   // âœ… CORRECT SSL PORT
    "cl_" + Math.random().toString(16).slice(2, 10)
);

client.onMessageArrived = (msg) => {
    const data = JSON.parse(msg.payloadString);
    log("RECEIVED: " + data.lat.toFixed(4) + ", " + data.lng.toFixed(4));
    updateMap(data.lat, data.lng, data.acc);
};

client.onConnectionLost = () => {
    log("MQTT CONNECTION LOST");
};

client.connect({
    useSSL: true,
    onSuccess: () => {
        log("MQTT CONNECTED");
        client.subscribe(TOPIC);
        document.getElementById("status").innerText =
            "Status: Connected & Listening";
    },
    onFailure: e => {
        log("MQTT ERROR: " + e.errorMessage);
    }
});

/* ---------------- START TRACKING ---------------- */
document.getElementById("start-btn").onclick = () => {
    log("START CLICKED");

    if (!navigator.geolocation) {
        log("ERROR: Geolocation not supported");
        return;
    }

    document.getElementById("status").innerText =
        "Status: Waiting for GPS permission...";

    navigator.geolocation.watchPosition(
        (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const acc = pos.coords.accuracy;

            log("GPS: " + lat.toFixed(4) + ", " + lng.toFixed(4));

            const message = new Paho.MQTT.Message(
                JSON.stringify({ lat, lng, acc })
            );
            message.destinationName = TOPIC;
            client.send(message);

            updateMap(lat, lng, acc);

            document.getElementById("status").innerText =
                "Status: ACTIVE & SENDING";
        },
        (err) => {
            log("GPS ERROR (" + err.code + "): " + err.message);
        },
        {
            enableHighAccuracy: false,
            timeout: 15000,
            maximumAge: 0
        }
    );
};
</script>

</body>
</html>
